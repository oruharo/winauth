# AWS NTLMç’°å¢ƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š Makefile
#
# ä½¿ç”¨æ–¹æ³•:
#   åˆå›è¨­å®š: make set-config
#   ãƒ‡ãƒ—ãƒ­ã‚¤:   make deploy

# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŒ‡å®šã‚’æ¤œå‡º
CMDLINE_KEY_NAME := $(filter command line,$(origin KEY_NAME))
CMDLINE_ADMIN_PASSWORD := $(filter command line,$(origin ADMIN_PASSWORD))
CMDLINE_USER_PASSWORD := $(filter command line,$(origin USER_PASSWORD))
CMDLINE_STACK_NAME := $(filter command line,$(origin STACK_NAME))
CMDLINE_ENV_PREFIX := $(filter command line,$(origin ENV_PREFIX))
CMDLINE_OWNER := $(filter command line,$(origin OWNER))
CMDLINE_TRUST_PASSWORD := $(filter command line,$(origin TRUST_PASSWORD))

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã¿ (å­˜åœ¨ã™ã‚‹å ´åˆ)
-include .env

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
STACK_NAME ?=
ENV_PREFIX ?=
OWNER ?= $(shell echo $${USER:-anyone})
SSH_KEY_PATH ?= ~/.ssh/$(KEY_NAME).pem

# è‰²è¨­å®š
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
SERVICE_PASSWORD ?= DefaultServicePass123!
TRUST_PASSWORD ?= DefaultTrustPass123!

# ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®ç„¡åŠ¹åŒ–
export no_proxy = *
export NO_PROXY = *
export http_proxy =
export https_proxy =
export HTTP_PROXY =
export HTTPS_PROXY =

##---------------------------------------------------------------------
##@ General
##---------------------------------------------------------------------
.PHONY: help
help: ## ãƒ˜ãƒ«ãƒ—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
	@awk 'BEGIN {FS = ":.*##"; printf "\n\033[34mAWS NTLMç’°å¢ƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š Makefile\033[0m\n\nUsage:\n  1. è¨­å®š:          make \033[36mset-config\033[0m\n  2. ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰: make \033[36minfrastructure\033[0m\n  3. ãƒ‡ãƒ—ãƒ­ã‚¤:      make \033[36mdeploy\033[0m\n\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

set-config: ## è¨­å®šã‚’å¯¾è©±å¼ã§å…¥åŠ›ã—ã¦.envãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            ## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŒ‡å®šä¾‹: make set-config KEY_NAME=xxx ADMIN_PASSWORD=xxx USER_PASSWORD=xxx STACK_NAME=xxx ENV_PREFIX=xxx OWNER=xxx TRUST_PASSWORD=xxx
	@# ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å…¨ã¦å¿…é ˆ
	@if [ -n "$(CMDLINE_KEY_NAME)" ] || [ -n "$(CMDLINE_ADMIN_PASSWORD)" ] || [ -n "$(CMDLINE_USER_PASSWORD)" ] || \
	   [ -n "$(CMDLINE_STACK_NAME)" ] || [ -n "$(CMDLINE_ENV_PREFIX)" ] || [ -n "$(CMDLINE_OWNER)" ] || [ -n "$(CMDLINE_TRUST_PASSWORD)" ]; then \
		if [ -z "$(CMDLINE_KEY_NAME)" ] || [ -z "$(CMDLINE_ADMIN_PASSWORD)" ] || [ -z "$(CMDLINE_USER_PASSWORD)" ] || \
		   [ -z "$(CMDLINE_STACK_NAME)" ] || [ -z "$(CMDLINE_ENV_PREFIX)" ] || [ -z "$(CMDLINE_OWNER)" ] || [ -z "$(CMDLINE_TRUST_PASSWORD)" ]; then \
			echo "$(RED)ã‚¨ãƒ©ãƒ¼: ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŒ‡å®šæ™‚ã¯å…¨ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…é ˆã§ã™$(NC)"; \
			echo "å¿…é ˆ: KEY_NAME, ADMIN_PASSWORD, USER_PASSWORD, STACK_NAME, ENV_PREFIX, OWNER, TRUST_PASSWORD"; \
			exit 1; \
		fi; \
		echo "# Auto-generated configuration" > .env; \
		echo "KEY_NAME=$(KEY_NAME)" >> .env; \
		echo "SSH_KEY_PATH=$(SSH_KEY_PATH)" >> .env; \
		echo "ADMIN_PASSWORD=$(ADMIN_PASSWORD)" >> .env; \
		echo "USER_PASSWORD=$(USER_PASSWORD)" >> .env; \
		echo "STACK_NAME=$(STACK_NAME)" >> .env; \
		echo "ENV_PREFIX=$(ENV_PREFIX)" >> .env; \
		echo "OWNER=$(OWNER)" >> .env; \
		echo "TRUST_PASSWORD=$(TRUST_PASSWORD)" >> .env; \
		echo "$(GREEN)âœ“ è¨­å®šã‚’ .env ã«ä¿å­˜ã—ã¾ã—ãŸ$(NC)"; \
	else \
		echo "$(GREEN)=== ç’°å¢ƒè¨­å®š ===$(NC)"; \
		echo ""; \
		if [ -f .env ]; then \
			echo "$(YELLOW)æ—¢å­˜ã®è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å¤‰æ›´ã—ãªã„å ´åˆã¯Enterã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚$(NC)"; \
			echo ""; \
		fi; \
		current_key=$$(grep "^KEY_NAME=" .env 2>/dev/null | cut -d= -f2); \
		read -p "KEY_NAME (AWS KeyPairå)$${current_key:+ [$$current_key]}: " key_name; \
		key_name=$${key_name:-$$current_key}; \
		current_ssh=$$(grep "^SSH_KEY_PATH=" .env 2>/dev/null | cut -d= -f2); \
		default_ssh=$${current_ssh:-~/.ssh/$$key_name.pem}; \
		read -p "SSH_KEY_PATH [$$default_ssh]: " ssh_path; \
		ssh_path=$${ssh_path:-$$default_ssh}; \
		current_admin=$$(grep "^ADMIN_PASSWORD=" .env 2>/dev/null | cut -d= -f2); \
		read -p "ADMIN_PASSWORD (Administrator ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)$${current_admin:+ [$$current_admin]}: " admin_pass; \
		admin_pass=$${admin_pass:-$$current_admin}; \
		current_user=$$(grep "^USER_PASSWORD=" .env 2>/dev/null | cut -d= -f2); \
		read -p "USER_PASSWORD (ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰)$${current_user:+ [$$current_user]}: " user_pass; \
		user_pass=$${user_pass:-$$current_user}; \
		current_stack=$$(grep "^STACK_NAME=" .env 2>/dev/null | cut -d= -f2); \
		read -p "STACK_NAME (CloudFormationã‚¹ã‚¿ãƒƒã‚¯å)$${current_stack:+ [$$current_stack]}: " stack_name; \
		stack_name=$${stack_name:-$$current_stack}; \
		current_env=$$(grep "^ENV_PREFIX=" .env 2>/dev/null | cut -d= -f2); \
		read -p "ENV_PREFIX (ãƒªã‚½ãƒ¼ã‚¹åprefixã€1-10æ–‡å­—è‹±æ•°å­—)$${current_env:+ [$$current_env]}: " env_prefix; \
		env_prefix=$${env_prefix:-$$current_env}; \
		current_owner=$$(grep "^OWNER=" .env 2>/dev/null | cut -d= -f2); \
		default_owner=$${current_owner:-$${USER:-anyone}}; \
		read -p "OWNER (ã‚¿ã‚°ç”¨ã€1-10æ–‡å­—è‹±æ•°å­—) [$$default_owner]: " owner; \
		owner=$${owner:-$$default_owner}; \
		current_trust=$$(grep "^TRUST_PASSWORD=" .env 2>/dev/null | cut -d= -f2); \
		default_trust=$${current_trust:-DefaultTrustPass123!}; \
		read -p "TRUST_PASSWORD [$$default_trust]: " trust_pass; \
		trust_pass=$${trust_pass:-$$default_trust}; \
		echo "# Auto-generated configuration" > .env; \
		echo "KEY_NAME=$$key_name" >> .env; \
		echo "SSH_KEY_PATH=$$ssh_path" >> .env; \
		echo "ADMIN_PASSWORD=$$admin_pass" >> .env; \
		echo "USER_PASSWORD=$$user_pass" >> .env; \
		echo "STACK_NAME=$$stack_name" >> .env; \
		echo "ENV_PREFIX=$$env_prefix" >> .env; \
		echo "OWNER=$$owner" >> .env; \
		echo "TRUST_PASSWORD=$$trust_pass" >> .env; \
		echo ""; \
		echo "$(GREEN)âœ“ è¨­å®šã‚’ .env ã«ä¿å­˜ã—ã¾ã—ãŸ$(NC)"; \
		echo "$(YELLOW)æ¬¡å›ä»¥é™ã¯ 'make deploy' ã ã‘ã§å®Ÿè¡Œã§ãã¾ã™$(NC)"; \
	fi

show-config: ## ä¿å­˜ã•ã‚ŒãŸè¨­å®šã‚’è¡¨ç¤º
	@if [ -f .env ]; then \
		echo "$(GREEN)ä¿å­˜ã•ã‚ŒãŸè¨­å®š:$(NC)"; \
		cat .env | grep -v "^#" | sed 's/^/  /'; \
	else \
		echo "$(YELLOW)ä¿å­˜ã•ã‚ŒãŸè¨­å®šã¯ã‚ã‚Šã¾ã›ã‚“$(NC)"; \
		echo "$(YELLOW)make set-config ã§è¨­å®šã‚’ä¿å­˜ã—ã¦ãã ã•ã„$(NC)"; \
	fi

##---------------------------------------------------------------------
## Prerequisites
##---------------------------------------------------------------------

# .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
check-env:
	@if [ ! -f .env ]; then \
		echo "$(RED)ã‚¨ãƒ©ãƒ¼: .env ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“$(NC)"; \
		echo "$(YELLOW)å…ˆã« 'make set-config' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„$(NC)"; \
		exit 1; \
	fi

# SSHéµã®å­˜åœ¨ç¢ºèª
check-ssh-key: check-env
	@echo "$(GREEN)SSHéµã‚’ç¢ºèªä¸­...$(NC)"
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	if [ ! -f "$$EXPANDED_PATH" ]; then \
		echo "$(RED)ã‚¨ãƒ©ãƒ¼: SSHç§˜å¯†éµãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $$EXPANDED_PATH$(NC)"; \
		echo "$(YELLOW)ç¢ºèªäº‹é …:$(NC)"; \
		echo "  - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹: $$EXPANDED_PATH"; \
		echo "  - ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ãŒé©åˆ‡ã‹: ls -la $$EXPANDED_PATH"; \
		exit 1; \
	fi
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	echo "$(GREEN)âœ“ SSHéµãŒç¢ºèªã§ãã¾ã—ãŸ: $$EXPANDED_PATH$(NC)"

# Ansibleç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
setup-ansible: check-env
	@echo "$(GREEN)Ansibleã‚’ç¢ºèªä¸­...$(NC)"
	@command -v ansible-playbook >/dev/null || (echo "$(RED)ã‚¨ãƒ©ãƒ¼: AnsibleãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“$(NC)" && exit 1)
	@echo "$(GREEN)âœ“ Ansible ãŒåˆ©ç”¨å¯èƒ½ã§ã™$(NC)"
	@echo "$(GREEN)Ansibleã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­...$(NC)"
	@ansible-galaxy collection install -r ansible/requirements.yml --force >/dev/null 2>&1
	@echo "$(GREEN)âœ“ Ansibleã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# CloudFormationå‡ºåŠ›ã®å–å¾—
get-cloudformation-outputs: check-env
	@echo "$(GREEN)CloudFormationå‡ºåŠ›ã‚’å–å¾—ä¸­...$(NC)"
	$(eval DC1_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`DC1PublicIP`].OutputValue' --output text))
	$(eval DC2_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`DC2PublicIP`].OutputValue' --output text))
	$(eval WIN1_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`WIN1PublicIP`].OutputValue' --output text))
	$(eval WIN2_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`WIN2PublicIP`].OutputValue' --output text))
	$(eval LINUX_PUBLIC_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`LinuxAppPublicIP`].OutputValue' --output text))
	$(eval ALB_DNS_NAME := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`ALBDNSName`].OutputValue' --output text))
	$(eval ALB_ARN := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`ALBArn`].OutputValue' --output text))
	$(eval VPC_ID := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`VPCId`].OutputValue' --output text))
	@echo "$(GREEN)âœ“ CloudFormationå‡ºåŠ›ã‚’å–å¾—ã—ã¾ã—ãŸ$(NC)"

# çµ±åˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®ä½œæˆï¼ˆMake inline ã§ç”Ÿæˆï¼‰

ansible/inventory/inventory.yml: get-cloudformation-outputs
	@echo "$(GREEN)çµ±åˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ä½œæˆä¸­...$(NC)"
	@mkdir -p ansible/inventory
	@{ \
		echo "all:"; \
		echo "  children:"; \
		echo "    # Windows Domain Controllers"; \
		echo "    domain_controllers:"; \
		echo "      hosts:"; \
		echo "        dc1:"; \
		echo "          ansible_host: $(DC1_IP)"; \
		echo "          domain_name: \"DOMAIN1.LAB\""; \
		echo "          domain_netbios: \"DOMAIN1\""; \
		echo "        dc2:"; \
		echo "          ansible_host: $(DC2_IP)"; \
		echo "          domain_name: \"DOMAIN2.LAB\""; \
		echo "          domain_netbios: \"DOMAIN2\""; \
		echo "      vars:"; \
		echo "        ansible_connection: winrm"; \
		echo "        ansible_winrm_server_cert_validation: ignore"; \
		echo "        ansible_winrm_transport: basic"; \
		echo "        ansible_winrm_scheme: http"; \
		echo "        ansible_port: 5985"; \
		echo "        ansible_user: \"Administrator\""; \
		echo "        ansible_password: \"$(ADMIN_PASSWORD)\""; \
		echo ""; \
		echo "    # Windows Clients"; \
		echo "    windows_clients:"; \
		echo "      hosts:"; \
		echo "        win1:"; \
		echo "          ansible_host: $(WIN1_IP)"; \
		echo "          target_domain: \"DOMAIN1.LAB\""; \
		echo "          domain_controller: \"10.0.10.10\""; \
		echo "          domain_user: \"user1\""; \
		echo "        win2:"; \
		echo "          ansible_host: $(WIN2_IP)"; \
		echo "          target_domain: \"DOMAIN2.LAB\""; \
		echo "          domain_controller: \"10.0.20.10\""; \
		echo "          domain_user: \"user2\""; \
		echo "      vars:"; \
		echo "        ansible_connection: winrm"; \
		echo "        ansible_winrm_server_cert_validation: ignore"; \
		echo "        ansible_winrm_transport: basic"; \
		echo "        ansible_winrm_scheme: http"; \
		echo "        ansible_port: 5985"; \
		echo "        ansible_user: \"Administrator\""; \
		echo "        ansible_password: \"$(ADMIN_PASSWORD)\""; \
		echo ""; \
		echo "    # Linux Application Server"; \
		echo "    linux_servers:"; \
		echo "      hosts:"; \
		echo "        linux-app:"; \
		echo "          ansible_host: $(LINUX_PUBLIC_IP)"; \
		echo "          ansible_user: ec2-user"; \
		EXPANDED_SSH_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
		echo "          ansible_ssh_private_key_file: $$EXPANDED_SSH_PATH"; \
		echo "          ansible_ssh_common_args: '-o StrictHostKeyChecking=no'"; \
		echo ""; \
		echo "    # Windows group (DC + Clients)"; \
		echo "    windows:"; \
		echo "      children:"; \
		echo "        domain_controllers:"; \
		echo "        windows_clients:"; \
		echo ""; \
		echo "  # Global variables"; \
		echo "  vars:"; \
		echo "    # Passwords"; \
		echo "    admin_password: \"$(ADMIN_PASSWORD)\""; \
		echo "    user_password: \"$(USER_PASSWORD)\""; \
		echo "    service_password: \"$(SERVICE_PASSWORD)\""; \
		echo "    trust_password: \"$(TRUST_PASSWORD)\""; \
		echo ""; \
		echo "    # Network settings"; \
		echo "    dc1_ip: \"10.0.10.10\""; \
		echo "    dc2_ip: \"10.0.20.10\""; \
		echo "    app_hostname: \"winauth.app.local\""; \
		echo "    app_private_ip: \"10.0.30.10\""; \
		echo "    linux_public_ip: \"$(LINUX_PUBLIC_IP)\""; \
		echo "    alb_dns_name: \"$(ALB_DNS_NAME)\""; \
		echo "    alb_arn: \"$(ALB_ARN)\""; \
		echo "    vpc_id: \"$(VPC_ID)\""; \
		echo ""; \
		echo "    # Application settings"; \
		echo "    java_package: \"java-17-amazon-corretto-devel\""; \
		echo "    app_user: \"ec2-user\""; \
		echo "    app_dir: \"/opt/winauth\""; \
	} > $@
	@echo "$(GREEN)âœ“ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ$(NC)"

##---------------------------------------------------------------------
## Core Tasks (Combined Workflows)
##---------------------------------------------------------------------

# ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼è¨­å®š
.run-domain-controllers: ansible/inventory/inventory.yml
	@echo "$(GREEN)ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’è¨­å®šä¸­...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	ansible-playbook -i ansible/inventory/inventory.yml ansible/setup-domain-controllers.yml $(ANSIBLE_LIMIT) -v
	@echo "$(GREEN)âœ“ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# Group Policyè¨­å®šï¼ˆã‚¤ãƒ³ãƒˆãƒ©ãƒãƒƒãƒˆã‚¾ãƒ¼ãƒ³ï¼‰
.run-group-policy: ansible/inventory/inventory.yml
	@echo "$(GREEN)Group Policyï¼ˆã‚¤ãƒ³ãƒˆãƒ©ãƒãƒƒãƒˆã‚¾ãƒ¼ãƒ³è¨­å®šï¼‰ã‚’é©ç”¨ä¸­...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	ansible-playbook -i ansible/inventory/inventory.yml ansible/setup-group-policy-intranet.yml $(ANSIBLE_LIMIT) -v
	@echo "$(GREEN)âœ“ Group Policyè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
.run-windows-clients: ansible/inventory/inventory.yml
	@echo "$(GREEN)Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¨­å®šä¸­...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	ansible-playbook -i ansible/inventory/inventory.yml ansible/setup-windows-clients.yml $(ANSIBLE_LIMIT) -v
	@echo "$(GREEN)âœ“ Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# ALBè¨­å®š
.run-alb-config: ansible/inventory/inventory.yml
	@echo "$(GREEN)ALB Target Groupsè¨­å®š...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; export ENV_PREFIX="$(ENV_PREFIX)"; export OWNER="$(OWNER)"; \
	ansible-playbook -i localhost, ansible/setup-alb-target-groups.yml -v
	@echo "$(GREEN)âœ“ ALB Target Groupsä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"
	@echo "$(GREEN)ALB Listenersè¨­å®š...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; export ENV_PREFIX="$(ENV_PREFIX)"; export OWNER="$(OWNER)"; \
	ansible-playbook -i localhost, ansible/setup-alb-listeners.yml -v
	@echo "$(GREEN)âœ“ ALB Listenersä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
.run-linux-app: ansible/inventory/inventory.yml
	@echo "$(GREEN)Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š...$(NC)"
	@ansible-playbook -i ansible/inventory/inventory.yml ansible/deploy-linux.yml -v
	@echo "$(GREEN)âœ“ Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

##---------------------------------------------------------------------
##@ Infrastructure
##---------------------------------------------------------------------

infrastructure: check-env ## AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ï¼ˆCloudFormationï¼‰
	@echo "$(GREEN)CloudFormationã§ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ§‹ç¯‰ä¸­...$(NC)"
	@echo "$(GREEN)ã‚¹ã‚¿ãƒƒã‚¯å: $(STACK_NAME)$(NC)"; \
	aws cloudformation create-stack \
		--stack-name $(STACK_NAME) \
		--template-body file://cloudformation.yaml \
		--parameters \
			ParameterKey=KeyName,ParameterValue=$(KEY_NAME) \
			ParameterKey=AdminPassword,ParameterValue=$(ADMIN_PASSWORD) \
			ParameterKey=UserPassword,ParameterValue=$(USER_PASSWORD) \
			ParameterKey=Prefix,ParameterValue=$(ENV_PREFIX) \
			ParameterKey=Owner,ParameterValue=$(OWNER) \
		--capabilities CAPABILITY_IAM \
		--region ap-northeast-1; \
	echo "$(YELLOW)ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰å®Œäº†ã‚’å¾…æ©Ÿä¸­...ï¼ˆç´„10åˆ†ï¼‰$(NC)"; \
	aws cloudformation wait stack-create-complete \
		--stack-name $(STACK_NAME) \
		--region ap-northeast-1; \
	echo "$(GREEN)âœ“ ã‚¤ãƒ³ãƒ•ãƒ©æ§‹ç¯‰ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"; \
	echo ""; \
	$(MAKE) generate-rdp; \
	echo ""; \
	echo "$(YELLOW)æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:$(NC)"; \
	echo "  make deploy    # å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤"

infra: infrastructure ## infrastructureã®çŸ­ç¸®å½¢

destroy: check-env ## AWSã‚¤ãƒ³ãƒ•ãƒ©ã‚’å‰Šé™¤
	@echo "$(RED)è­¦å‘Š: ã‚¹ã‚¿ãƒƒã‚¯ $(STACK_NAME) ã‚’å‰Šé™¤ã—ã¾ã™$(NC)"
	@echo "$(YELLOW)å‰Šé™¤ã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹:$(NC)"
	@echo "  - EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ (DC1, DC2, WIN1, WIN2, Linux)"
	@echo "  - Application Load Balancer"
	@echo "  - VPC ãŠã‚ˆã³ã‚µãƒ–ãƒãƒƒãƒˆ"
	@echo ""
	@read -p "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (yes/no): " confirm; \
	if [ "$$confirm" = "yes" ]; then \
		aws cloudformation delete-stack \
			--stack-name $(STACK_NAME) \
			--region ap-northeast-1; \
		echo "$(GREEN)ã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸ$(NC)"; \
		echo "$(YELLOW)å‰Šé™¤å®Œäº†ã‚’å¾…æ©Ÿä¸­...$(NC)"; \
		aws cloudformation wait stack-delete-complete \
			--stack-name $(STACK_NAME) \
			--region ap-northeast-1; \
		echo "$(GREEN)âœ“ ã‚¤ãƒ³ãƒ•ãƒ©å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"; \
		rm -f ansible/inventory/inventory.yml; \
	else \
		echo "$(YELLOW)å‰Šé™¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ$(NC)"; \
	fi

stack-status: check-env ## CloudFormationã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèª
	@aws cloudformation describe-stacks \
		--stack-name $(STACK_NAME) \
		--query 'Stacks[0].[StackName,StackStatus]' \
		--output table \
		--region ap-northeast-1

##---------------------------------------------------------------------
##@ Server-specific Deployment
##---------------------------------------------------------------------

# å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼è¨­å®š - ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
deploy-dc1: ANSIBLE_LIMIT = --limit dc1
deploy-dc1: setup-ansible .run-domain-controllers ## DC1ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆDOMAIN1ï¼‰

deploy-dc2: ANSIBLE_LIMIT = --limit dc2
deploy-dc2: setup-ansible .run-domain-controllers ## DC2ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆDOMAIN2ï¼‰

deploy-dc: setup-ansible .run-domain-controllers .run-group-policy ## ä¸¡æ–¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆGPOå«ã‚€ï¼‰

# å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼è¨­å®š - Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
deploy-win1: ANSIBLE_LIMIT = --limit win1
deploy-win1: setup-ansible .run-windows-clients ## WIN1ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆDOMAIN1ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰

deploy-win2: ANSIBLE_LIMIT = --limit win2
deploy-win2: setup-ansible .run-windows-clients ## WIN2ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆDOMAIN2ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰

deploy-win: setup-ansible .run-windows-clients ## ä¸¡æ–¹ã®Windowsã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

# Group Policyè¨­å®š
deploy-gpo: setup-ansible .run-group-policy ## Group Policyï¼ˆã‚¤ãƒ³ãƒˆãƒ©ãƒãƒƒãƒˆã‚¾ãƒ¼ãƒ³è¨­å®šï¼‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

# ALBè¨­å®š
deploy-alb: setup-ansible .run-alb-config ## ALBè¨­å®šã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆTarget Groups + Listenersï¼‰

# Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
deploy-linux: check-ssh-key setup-ansible .run-linux-app ## Linuxã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤

# å…¨ä½“ãƒ‡ãƒ—ãƒ­ã‚¤
deploy: deploy-dc deploy-win deploy-alb deploy-linux show-info ## å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆDC + WIN + ALB + Linuxï¼‰
	@echo ""
	@echo "$(BLUE)=== ğŸ‰ å…¨ä½“æ§‹ç¯‰å®Œäº† ğŸ‰ ===$(NC)"
	@echo "$(GREEN)âœ… å…¨ã¦ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼èªè¨¼ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚$(NC)"
	@echo ""

##---------------------------------------------------------------------
##@ Information & Testing
##---------------------------------------------------------------------

show-info: get-cloudformation-outputs ## æ¥ç¶šæƒ…å ±ã‚’è¡¨ç¤º
	@echo ""
	@echo "$(YELLOW)ğŸ“‹ æ¥ç¶šæƒ…å ±:$(NC)"
	@echo "  DC1 (DOMAIN1):     $(DC1_IP)"
	@echo "  DC2 (DOMAIN2):     $(DC2_IP)"
	@echo "  WIN1:              $(WIN1_IP)"
	@echo "  WIN2:              $(WIN2_IP)"
	@echo "  Linux App:         $(LINUX_PUBLIC_IP)"
	@echo "  ALB DNS:           $(ALB_DNS_NAME)"
	@echo ""
	@echo "$(YELLOW)ğŸŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URL:$(NC)"
	@echo "  WinAuth (ALBçµŒç”±): https://$(ALB_DNS_NAME)"
	@echo ""
	@echo "$(YELLOW)ğŸ–¥ï¸ RDPæ¥ç¶š (Administrator):$(NC)"
	@echo "  DC1:               rdp://$(DC1_IP)"
	@echo "  DC2:               rdp://$(DC2_IP)"
	@echo "  WIN1:              rdp://$(WIN1_IP)"
	@echo "  WIN2:              rdp://$(WIN2_IP)"
	@echo ""
	@echo "$(YELLOW)ğŸ” SSHæ¥ç¶š:$(NC)"
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	echo "  Linux App:         ssh -i $$EXPANDED_PATH ec2-user@$(LINUX_PUBLIC_IP)"
	@echo ""

test-urls: get-cloudformation-outputs ## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URLã‚’ãƒ†ã‚¹ãƒˆ
	@echo "$(GREEN)ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URLã‚’ãƒ†ã‚¹ãƒˆä¸­...$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸŒ ALBçµŒç”±ãƒ†ã‚¹ãƒˆ:$(NC)"
	@curl -s -o /dev/null -w "  Status: %{http_code} - %{url_effective}\n" https://$(ALB_DNS_NAME) || echo "  âŒ ALBçµŒç”±æ¥ç¶šå¤±æ•—"
	@echo ""

generate-rdp: get-cloudformation-outputs ## RDPæ¥ç¶šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
	@echo "$(GREEN)RDPæ¥ç¶šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...$(NC)"
	@mkdir -p rdp
	@sed 's/full address:s:.*/full address:s:$(DC1_IP)/' rdp.template | \
	 sed 's/username:s:.*/username:s:$(DC1_IP)\\Administrator/' > rdp/dc1.rdp
	@sed 's/full address:s:.*/full address:s:$(DC2_IP)/' rdp.template | \
	 sed 's/username:s:.*/username:s:$(DC2_IP)\\Administrator/' > rdp/dc2.rdp
	@sed 's/full address:s:.*/full address:s:$(WIN1_IP)/' rdp.template | \
	 sed 's/username:s:.*/username:s:$(WIN1_IP)\\Administrator/' > rdp/win1.rdp
	@sed 's/full address:s:.*/full address:s:$(WIN1_IP)/' rdp.template | \
	 sed 's/username:s:.*/username:s:DOMAIN1\\user1/' > rdp/win1-user1.rdp
	@sed 's/full address:s:.*/full address:s:$(WIN2_IP)/' rdp.template | \
	 sed 's/username:s:.*/username:s:$(WIN2_IP)\\Administrator/' > rdp/win2.rdp
	@sed 's/full address:s:.*/full address:s:$(WIN2_IP)/' rdp.template | \
	 sed 's/username:s:.*/username:s:DOMAIN2\\user2/' > rdp/win2-user2.rdp
	@echo "$(GREEN)âœ“ RDPæ¥ç¶šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ: rdp/$(NC)"
	@echo "  - rdp/dc1.rdp        ($(DC1_IP) - Administrator)"
	@echo "  - rdp/dc2.rdp        ($(DC2_IP) - Administrator)"
	@echo "  - rdp/win1.rdp       ($(WIN1_IP) - Administrator)"
	@echo "  - rdp/win1-user1.rdp ($(WIN1_IP) - DOMAIN1\\user1)"
	@echo "  - rdp/win2.rdp       ($(WIN2_IP) - Administrator)"
	@echo "  - rdp/win2-user2.rdp ($(WIN2_IP) - DOMAIN2\\user2)"

##---------------------------------------------------------------------
##@ Maintenance
##---------------------------------------------------------------------

clean: ## ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
	@echo "$(GREEN)ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­...$(NC)"
	@rm -f ansible/inventory/inventory.yml
	@rm -rf rdp
	@echo "$(GREEN)âœ“ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help