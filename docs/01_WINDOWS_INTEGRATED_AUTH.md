# 第1章: Windows認証の基礎

## 1.1 認証方式の概要

Windows統合認証には、主に2つの認証プロトコルがあります。

### Kerberos認証（SPNEGO）
Kerberosは、チケットベースの認証プロトコルです。

- **仕組み**: KDC（Key Distribution Center）がチケットを発行し、クライアントとサーバー間で認証
- **セキュリティ**: 高い（暗号化チケット、相互認証、チケット有効期限）
- **パフォーマンス**: 優れている（チケットキャッシュによる再認証の高速化）
- **設定複雑度**: 高い（SPN登録、keytab生成、krb5.conf設定が必要）

### NTLM認証
NTLMは、チャレンジ・レスポンス方式の認証プロトコルです。

- **仕組み**: サーバーがチャレンジを送信し、クライアントがハッシュで応答
- **セキュリティ**: 中程度（Kerberosより劣るが、統合Windows認証では実用的）
- **パフォーマンス**: やや劣る（毎回ドメインコントローラーとの通信が必要）
- **設定複雑度**: 低い（既存のドメイン設定をそのまま利用可能）

## 1.2 KerberosとNTLMの設定要件比較

| 設定項目 | Kerberos | NTLM | 備考 |
|---------|----------|------|------|
| **ドメインコントローラー設定** |
| SPN登録 | ✅ 必要 | ❌ 不要 | setspn -A HTTP/service user |
| サービスアカウント作成 | ✅ 必要 | ❌ 不要 | Kerberosのみ専用アカウント必要 |
| keytab生成 | ✅ 必要 | ❌ 不要 | ktpassコマンドで生成 |
| RC4/AES暗号化設定 | ✅ 必要 | ❌ 不要 | allow_weak_crypto = true |
| **クロスドメイン設定** |
| 両ドメインでのSPN | ✅ 必要 | ❌ 不要 | 各ドメインで個別設定 |
| 両ドメインでのkeytab | ✅ 必要 | ❌ 不要 | マージ作業が複雑 |
| 信頼関係 | ✅ 必要 | ✅ 必要 | 両方式で必要（既存） |
| DNS設定 | ✅ 必要 | ❌ 不要 | conditional forwarder |
| **アプリケーション設定** |
| krb5.conf | ✅ 必要 | ❌ 不要 | レルム、KDC設定 |
| JVM RC4設定 | ✅ 必要 | ❌ 不要 | Java 17制約回避 |
| Spring Security設定 | 🔄 複雑 | ✅ シンプル | SPNEGO vs NTLM |
| keytabファイル配置 | ✅ 必要 | ❌ 不要 | セキュアな配置必要 |
| **クライアント設定** |
| ブラウザ設定 | ✅ 必要 | ✅ 必要 | 統合認証有効化（同じ設定） |
| イントラネットゾーン | ✅ 必要 | ✅ 必要 | ドメイン追加（同じ設定） |
| **運用・保守** |
| keytab更新 | ✅ 必要 | ❌ 不要 | パスワード変更時 |
| 証明書管理 | ✅ 必要 | ❌ 不要 | keytab暗号化証明書 |
| DOMAIN2作業 | ✅ 必要 | ❌ 不要 | 海外拠点協力が不要 |

## 1.3 選択時の考慮事項

### Kerberos認証の選択を検討する場合
- セキュリティ要件が厳しい環境
- 単一ドメイン環境
- パフォーマンスが重要な場合
- Active Directory管理者権限がある
- すべてのドメインで作業可能な環境

### NTLM認証の選択を検討する場合
- クロスドメイン環境
- 設定を簡素化したい場合
- 海外拠点での作業が困難な環境
- 迅速な実装が必要な場合
- Java 17のRC4制約を回避したい場合

### 共通要件
どちらの方式でも以下は必要です：
- ドメイン参加Windowsクライアント
- ドメイン信頼関係（クロスドメインの場合）
- ブラウザの統合認証設定
- Spring Boot + Spring Security

## 1.4 ユーザー体験

どちらの方式でも、ドメインユーザーには以下のような体験を提供します：

1. ドメインにログイン済みのWindowsクライアントからアクセス
2. **パスワード入力不要**で自動的に認証
3. ユーザー名、ドメイン、グループ情報を取得
4. シームレスなシングルサインオン（SSO）

認証方式の違いはバックエンドの実装であり、エンドユーザーからは透過的です。

## 次の章へ

- [第2章: Kerberos認証詳解](./02_KERBEROS.md) - Kerberos認証の技術詳細
- [第3章: NTLM認証詳解](./03_NTLM.md) - NTLM認証の実装ガイド
- [第4章: クロスドメイン認証](./04_CROSS_DOMAIN.md) - クロスドメイン環境での認証
