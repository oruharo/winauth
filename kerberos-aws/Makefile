# AWS Kerberosç’°å¢ƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š Makefile
#
# ä½¿ç”¨æ–¹æ³•:
#   make deploy KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass
#   make deploy-dc1 KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass
#   make deploy-win1 KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
PREFIX ?= KrbTest
SSH_KEY_PATH ?= ~/.ssh/$(KEY_NAME).pem

# è‰²è¨­å®š
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
NC := \033[0m

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
SERVICE_PASSWORD ?= DefaultServicePass123!
TRUST_PASSWORD ?= DefaultTrustPass123!

# ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã®ç„¡åŠ¹åŒ–
export no_proxy = *
export NO_PROXY = *
export http_proxy =
export https_proxy =
export HTTP_PROXY =
export HTTPS_PROXY =

##---------------------------------------------------------------------
##@ General
##---------------------------------------------------------------------
.PHONY: help
help: ## Display this help.
	@awk 'BEGIN {FS = ":.*##"; printf "\n\033[34mAWS Kerberosç’°å¢ƒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š Makefile\033[0m\n\nUsage:\n  make \033[36m<target>\033[0m KEY_NAME=<keypair> ADMIN_PASSWORD=<pass> USER_PASSWORD=<pass>\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)
	@echo ""
	@echo "\033[33må¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:\033[0m"
	@echo "  KEY_NAME          AWS KeyPairå"
	@echo "  ADMIN_PASSWORD    Administrator ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
	@echo "  USER_PASSWORD     ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
	@echo ""
	@echo "\033[33mã‚ªãƒ—ã‚·ãƒ§ãƒ³:\033[0m"
	@echo "  PREFIX=KrbTest      ã‚¹ã‚¿ãƒƒã‚¯ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹"
	@echo "  SSH_KEY_PATH        SSHç§˜å¯†éµãƒ‘ã‚¹ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: ~/.ssh/KEY_NAME.pem)"
	@echo "  SERVICE_PASSWORD    ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: DefaultServicePass123!)"
	@echo "  TRUST_PASSWORD      ãƒ‰ãƒ¡ã‚¤ãƒ³ä¿¡é ¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: DefaultTrustPass123!)"

##---------------------------------------------------------------------
##@ Prerequisites
##---------------------------------------------------------------------

# å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ãƒã‚§ãƒƒã‚¯
check-params:
ifndef KEY_NAME
	@echo "$(RED)ã‚¨ãƒ©ãƒ¼: KEY_NAME ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“$(NC)"
	@echo "ä¾‹: make deploy KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass"
	@exit 1
endif
ifndef ADMIN_PASSWORD
	@echo "$(RED)ã‚¨ãƒ©ãƒ¼: ADMIN_PASSWORD ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“$(NC)"
	@echo "ä¾‹: make deploy KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass"
	@exit 1
endif
ifndef USER_PASSWORD
	@echo "$(RED)ã‚¨ãƒ©ãƒ¼: USER_PASSWORD ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“$(NC)"
	@echo "ä¾‹: make deploy KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass"
	@exit 1
endif

# SSHéµã®å­˜åœ¨ç¢ºèª
check-ssh-key: check-params
	@echo "$(GREEN)SSHéµã‚’ç¢ºèªä¸­...$(NC)"
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	if [ ! -f "$$EXPANDED_PATH" ]; then \
		echo "$(RED)ã‚¨ãƒ©ãƒ¼: SSHç§˜å¯†éµãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $$EXPANDED_PATH$(NC)"; \
		echo "$(YELLOW)ç¢ºèªäº‹é …:$(NC)"; \
		echo "  - ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒæ­£ã—ã„ã‹: $$EXPANDED_PATH"; \
		echo "  - ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ãŒé©åˆ‡ã‹: ls -la $$EXPANDED_PATH"; \
		exit 1; \
	fi
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	echo "$(GREEN)âœ“ SSHéµãŒç¢ºèªã§ãã¾ã—ãŸ: $$EXPANDED_PATH$(NC)"

# Ansibleã®ç¢ºèª
check-ansible:
	@echo "$(GREEN)Ansibleã‚’ç¢ºèªä¸­...$(NC)"
	@command -v ansible-playbook >/dev/null || (echo "$(RED)ã‚¨ãƒ©ãƒ¼: AnsibleãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“$(NC)" && exit 1)
	@echo "$(GREEN)âœ“ Ansible ãŒåˆ©ç”¨å¯èƒ½ã§ã™$(NC)"

# ã‚¹ã‚¿ãƒƒã‚¯åã®å–å¾—
get-stack-name: check-params
	$(eval STACK_NAME := $(shell aws cloudformation list-stacks --stack-status-filter CREATE_COMPLETE UPDATE_COMPLETE --query "StackSummaries[?starts_with(StackName, \`$(PREFIX)-kerberos-test-\`)].StackName" --output text | head -1))
	@test -n "$(STACK_NAME)" || (echo "$(RED)ã‚¨ãƒ©ãƒ¼: $(PREFIX)-kerberos-test-* ã‚¹ã‚¿ãƒƒã‚¯ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“$(NC)" && exit 1)
	@echo "$(GREEN)ã‚¹ã‚¿ãƒƒã‚¯å: $(STACK_NAME)$(NC)"

# Ansibleã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèªãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
setup-ansible-collections: check-ansible
	@echo "$(GREEN)Ansibleã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºèªä¸­...$(NC)"
	@if [ -f "ansible/requirements.yml" ]; then \
		ansible-galaxy collection install -r ansible/requirements.yml --force >/dev/null 2>&1; \
	else \
		ansible-galaxy collection install amazon.aws community.aws --force >/dev/null 2>&1; \
	fi
	@echo "$(GREEN)âœ“ Ansibleã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒæº–å‚™å®Œäº†$(NC)"

# CloudFormationå‡ºåŠ›ã®å–å¾—
get-cloudformation-outputs: get-stack-name
	@echo "$(GREEN)CloudFormationå‡ºåŠ›ã‚’å–å¾—ä¸­...$(NC)"
	$(eval DC1_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`DC1PublicIP`].OutputValue' --output text))
	$(eval DC2_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`DC2PublicIP`].OutputValue' --output text))
	$(eval WIN1_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`WIN1PublicIP`].OutputValue' --output text))
	$(eval WIN2_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`WIN2PublicIP`].OutputValue' --output text))
	$(eval LINUX_PUBLIC_IP := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`LinuxAppPublicIP`].OutputValue' --output text))
	$(eval ALB_DNS_NAME := $(shell aws cloudformation describe-stacks --stack-name $(STACK_NAME) --query 'Stacks[0].Outputs[?OutputKey==`ALBDNSName`].OutputValue' --output text))
	@echo ""
	@echo "$(YELLOW)å–å¾—ã—ãŸIPæƒ…å ±:$(NC)"
	@echo "  DC1 (DOMAIN1):     $(DC1_IP)"
	@echo "  DC2 (DOMAIN2):     $(DC2_IP)"
	@echo "  WIN1:              $(WIN1_IP)"
	@echo "  WIN2:              $(WIN2_IP)"
	@echo "  Linux App:         $(LINUX_PUBLIC_IP)"
	@echo "  ALB DNS:           $(ALB_DNS_NAME)"
	@echo ""
	@echo "$(YELLOW)æ¥ç¶šURL:$(NC)"
	@echo "  WinAuth App:       http://$(LINUX_PUBLIC_IP):8082"
	@echo "  WinAuth via ALB:   http://$(ALB_DNS_NAME)"
	@echo ""
	@echo "$(YELLOW)RDPæ¥ç¶š (ãƒ¦ãƒ¼ã‚¶ãƒ¼: Administrator):$(NC)"
	@echo "  DC1:               rdp://$(DC1_IP)"
	@echo "  DC2:               rdp://$(DC2_IP)"
	@echo "  WIN1:              rdp://$(WIN1_IP)"
	@echo "  WIN2:              rdp://$(WIN2_IP)"
	@echo ""
	@echo "$(YELLOW)SSHæ¥ç¶š:$(NC)"
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	echo "  Linux App:         ssh -i $$EXPANDED_PATH ec2-user@$(LINUX_PUBLIC_IP)"
	@echo ""

# çµ±åˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã®ä½œæˆï¼ˆMake inline ã§ç”Ÿæˆï¼‰

ansible/inventory/inventory.yml: get-cloudformation-outputs
	@echo "$(GREEN)çµ±åˆã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’ä½œæˆä¸­...$(NC)"
	@mkdir -p ansible/inventory
	@{ \
		echo "all:"; \
		echo "  children:"; \
		echo "    # Windows Domain Controllers"; \
		echo "    domain_controllers:"; \
		echo "      hosts:"; \
		echo "        dc1:"; \
		echo "          ansible_host: $(DC1_IP)"; \
		echo "          domain_name: \"DOMAIN1.LAB\""; \
		echo "          domain_netbios: \"DOMAIN1\""; \
		echo "        dc2:"; \
		echo "          ansible_host: $(DC2_IP)"; \
		echo "          domain_name: \"DOMAIN2.LAB\""; \
		echo "          domain_netbios: \"DOMAIN2\""; \
		echo "      vars:"; \
		echo "        ansible_connection: winrm"; \
		echo "        ansible_winrm_server_cert_validation: ignore"; \
		echo "        ansible_winrm_transport: basic"; \
		echo "        ansible_winrm_scheme: http"; \
		echo "        ansible_port: 5985"; \
		echo "        ansible_user: \"Administrator\""; \
		echo "        ansible_password: \"$(ADMIN_PASSWORD)\""; \
		echo ""; \
		echo "    # Windows Clients"; \
		echo "    windows_clients:"; \
		echo "      hosts:"; \
		echo "        win1:"; \
		echo "          ansible_host: $(WIN1_IP)"; \
		echo "          target_domain: \"DOMAIN1.LAB\""; \
		echo "          domain_controller: \"10.0.10.10\""; \
		echo "          domain_user: \"user1\""; \
		echo "        win2:"; \
		echo "          ansible_host: $(WIN2_IP)"; \
		echo "          target_domain: \"DOMAIN2.LAB\""; \
		echo "          domain_controller: \"10.0.20.10\""; \
		echo "          domain_user: \"user2\""; \
		echo "      vars:"; \
		echo "        ansible_connection: winrm"; \
		echo "        ansible_winrm_server_cert_validation: ignore"; \
		echo "        ansible_winrm_transport: basic"; \
		echo "        ansible_winrm_scheme: http"; \
		echo "        ansible_port: 5985"; \
		echo "        ansible_user: \"Administrator\""; \
		echo "        ansible_password: \"$(ADMIN_PASSWORD)\""; \
		echo ""; \
		echo "    # Linux Application Server"; \
		echo "    linux_servers:"; \
		echo "      hosts:"; \
		echo "        linux-app:"; \
		echo "          ansible_host: $(LINUX_PUBLIC_IP)"; \
		echo "          ansible_user: ec2-user"; \
		EXPANDED_SSH_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
		echo "          ansible_ssh_private_key_file: $$EXPANDED_SSH_PATH"; \
		echo "          ansible_ssh_common_args: '-o StrictHostKeyChecking=no'"; \
		echo ""; \
		echo "    # Windows group (DC + Clients)"; \
		echo "    windows:"; \
		echo "      children:"; \
		echo "        domain_controllers:"; \
		echo "        windows_clients:"; \
		echo ""; \
		echo "  # Global variables"; \
		echo "  vars:"; \
		echo "    # Passwords"; \
		echo "    admin_password: \"$(ADMIN_PASSWORD)\""; \
		echo "    user_password: \"$(USER_PASSWORD)\""; \
		echo "    service_password: \"$(SERVICE_PASSWORD)\""; \
		echo "    trust_password: \"$(TRUST_PASSWORD)\""; \
		echo ""; \
		echo "    # Network settings"; \
		echo "    dc1_ip: \"10.0.10.10\""; \
		echo "    dc2_ip: \"10.0.20.10\""; \
		echo "    app_hostname: \"winauth.app.local\""; \
		echo "    app_private_ip: \"10.0.30.10\""; \
		echo ""; \
		echo "    # Kerberos settings"; \
		echo "    primary_realm: \"DOMAIN1.LAB\""; \
		echo "    secondary_realm: \"DOMAIN2.LAB\""; \
		echo ""; \
		echo "    # Application settings"; \
		echo "    java_package: \"java-17-amazon-corretto-devel\""; \
		echo "    app_user: \"ec2-user\""; \
		echo "    app_dir: \"/opt/winauth\""; \
		echo "    keytab_dir: \"/etc/kerberos\""; \
		echo "    keytab_name: \"winauth-combined.keytab\""; \
	} > $@
	@echo "$(GREEN)âœ“ ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ$(NC)"

##---------------------------------------------------------------------
##@ Core Tasks (Combined Workflows)
##---------------------------------------------------------------------

# ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼è¨­å®š
.run-domain-controllers: ansible/inventory/inventory.yml
	@echo "$(GREEN)ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’è¨­å®šä¸­...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	ansible-playbook -i ansible/inventory/inventory.yml ansible/setup-domain-controllers.yml $(ANSIBLE_LIMIT) -v
	@echo "$(GREEN)âœ“ ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
.run-windows-clients: ansible/inventory/inventory.yml
	@echo "$(GREEN)Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¨­å®šä¸­...$(NC)"
	@ansible-playbook -i ansible/inventory/inventory.yml ansible/setup-windows-clients.yml $(ANSIBLE_LIMIT) -v
	@echo "$(GREEN)âœ“ Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"
	@echo "$(GREEN)ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šï¼ˆKerberosèªè¨¼ç”¨ï¼‰...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	ansible-playbook -i ansible/inventory/inventory.yml ansible/configure-browser-kerberos.yml $(ANSIBLE_LIMIT) -v
	@echo "$(GREEN)âœ“ ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
.run-linux-app: ansible/inventory/inventory.yml
	@echo "$(GREEN)ALB Target Groupsè¨­å®š...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; export PREFIX="$(PREFIX)"; \
	ansible-playbook -i localhost, ansible/setup-alb-target-groups.yml -v
	@echo "$(GREEN)âœ“ ALB Target Groupsä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"
	@echo "$(GREEN)ALB Listenersè¨­å®š...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	ansible-playbook -i localhost, ansible/setup-alb-listeners.yml -v
	@echo "$(GREEN)âœ“ ALB Listenersä½œæˆãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"
	@echo "$(GREEN)Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š...$(NC)"
	@echo "SSHæ¥ç¶šã®æº–å‚™ã‚’å¾…æ©Ÿä¸­..."
	@sleep 30
	@ansible-playbook -i ansible/inventory/inventory.yml ansible/deploy-linux.yml -v
	@echo "$(GREEN)âœ“ Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

##---------------------------------------------------------------------
##@ Individual Playbooks
##---------------------------------------------------------------------

# Playbookã‚’ç›´æ¥å®Ÿè¡Œã™ã‚‹æ±ç”¨ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
run-playbook: ansible/inventory/inventory.yml ## Run specific playbook (usage: make run-playbook PLAYBOOK=setup-domain-controllers.yml)
ifndef PLAYBOOK
	@echo "$(RED)ã‚¨ãƒ©ãƒ¼: PLAYBOOK ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿…è¦ã§ã™$(NC)"
	@echo "ä¾‹: make run-playbook PLAYBOOK=setup-domain-controllers.yml KEY_NAME=my-keypair ADMIN_PASSWORD=pass USER_PASSWORD=pass"
	@echo "åˆ©ç”¨å¯èƒ½ãªPlaybook:"
	@ls ansible/*.yml | grep -v requirements.yml | sed 's|ansible/||' | sed 's/^/  /'
	@exit 1
endif
	@echo "$(GREEN)Playbook '$(PLAYBOOK)' ã‚’å®Ÿè¡Œä¸­...$(NC)"
	@export STACK_NAME="$(STACK_NAME)"; \
	if [ "$(PLAYBOOK)" = "setup-alb-target-groups.yml" ] || [ "$(PLAYBOOK)" = "setup-alb-listeners.yml" ]; then \
		export PREFIX="$(PREFIX)"; \
		ansible-playbook -i localhost, ansible/$(PLAYBOOK) $(ANSIBLE_LIMIT) -v; \
	else \
		ansible-playbook -i ansible/inventory/inventory.yml ansible/$(PLAYBOOK) $(ANSIBLE_LIMIT) -v; \
	fi
	@echo "$(GREEN)âœ“ Playbook '$(PLAYBOOK)' ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# å€‹åˆ¥Playbookã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
setup-domain-controllers: PLAYBOOK = setup-domain-controllers.yml
setup-domain-controllers: check-ssh-key setup-ansible-collections run-playbook ## Setup domain controllers

setup-windows-clients: check-ssh-key setup-ansible-collections .run-windows-clients ## Setup Windows clients

configure-browser-kerberos: PLAYBOOK = configure-browser-kerberos.yml
configure-browser-kerberos: check-ssh-key setup-ansible-collections run-playbook ## Configure browser for Kerberos

configure-browser-kerberos-new: PLAYBOOK = configure-browser-kerberos-new.yml
configure-browser-kerberos-new: check-ssh-key setup-ansible-collections run-playbook ## Configure browser for Kerberos (new version)

deploy-linux: PLAYBOOK = deploy-linux.yml
deploy-linux: check-ssh-key setup-ansible-collections run-playbook ## Deploy Linux application

setup-alb-target-groups: PLAYBOOK = setup-alb-target-groups.yml
setup-alb-target-groups: check-ssh-key setup-ansible-collections run-playbook ## Setup ALB target groups

setup-alb-listeners: PLAYBOOK = setup-alb-listeners.yml
setup-alb-listeners: check-ssh-key setup-ansible-collections run-playbook ## Setup ALB listeners

create-alb-keytab: PLAYBOOK = create-alb-keytab.yml
create-alb-keytab: check-ssh-key setup-ansible-collections run-playbook ## Create ALB keytab

add-alb-spn: PLAYBOOK = add-alb-spn.yml
add-alb-spn: check-ssh-key setup-ansible-collections run-playbook ## Add ALB SPN

setup-alb: PLAYBOOK = setup-alb.yml
setup-alb: check-ssh-key setup-ansible-collections run-playbook ## Setup ALB

configure-nginx-alb: PLAYBOOK = configure-nginx-alb.yml
configure-nginx-alb: check-ssh-key setup-ansible-collections run-playbook ## Configure nginx for ALB

##---------------------------------------------------------------------
##@ Step-by-step Workflow
##---------------------------------------------------------------------

# ã‚¹ãƒ†ãƒƒãƒ—åˆ¥å®Ÿè¡Œï¼ˆæ¨å¥¨é †åºï¼‰
step1-domain-controllers: setup-domain-controllers ## Step 1: Setup domain controllers

step2-windows-clients: setup-windows-clients ## Step 2: Setup Windows clients

step3-browser-config: configure-browser-kerberos ## Step 3: Configure browser for Kerberos

step4-alb-target-groups: setup-alb-target-groups ## Step 4a: Setup ALB target groups

step5-alb-listeners: setup-alb-listeners ## Step 5b: Setup ALB listeners

step6-linux-app: deploy-linux-with-wait ## Step 6: Deploy Linux application (with wait)

# Linux ãƒ‡ãƒ—ãƒ­ã‚¤ç”¨ã®å¾…æ©Ÿä»˜ãã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
deploy-linux-with-wait: ansible/inventory/inventory.yml
	@echo "$(GREEN)SSHæ¥ç¶šã®æº–å‚™ã‚’å¾…æ©Ÿä¸­...$(NC)"
	@sleep 30
	@echo "$(GREEN)Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š...$(NC)"
	@ansible-playbook -i ansible/inventory/inventory.yml ansible/deploy-linux.yml -v
	@echo "$(GREEN)âœ“ Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †æ¬¡å®Ÿè¡Œ
deploy-step-by-step: step1-domain-controllers step2-windows-clients step3-browser-config step4-alb-target-groups step5-alb-listeners step6-linux-app ## Deploy all components step by step
	@echo ""
	@echo "$(BLUE)=== ğŸ‰ ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº† ğŸ‰ ===$(NC)"
	@echo "$(GREEN)å…¨6ã‚¹ãƒ†ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ$(NC)"

##---------------------------------------------------------------------
##@ Server-specific Deployment
##---------------------------------------------------------------------

# å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼è¨­å®š - ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼
deploy-dc1: ANSIBLE_LIMIT = --limit dc1
deploy-dc1: check-ssh-key setup-ansible-collections .run-domain-controllers ## Deploy DC1 only

deploy-dc2: ANSIBLE_LIMIT = --limit dc2
deploy-dc2: check-ssh-key setup-ansible-collections .run-domain-controllers ## Deploy DC2 only

deploy-domain-controllers: check-ssh-key setup-ansible-collections .run-domain-controllers ## Deploy both domain controllers

# å€‹åˆ¥ã‚µãƒ¼ãƒãƒ¼è¨­å®š - Windows ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
deploy-win1: ANSIBLE_LIMIT = --limit win1
deploy-win1: check-ssh-key setup-ansible-collections .run-windows-clients ## Deploy WIN1 only

deploy-win2: ANSIBLE_LIMIT = --limit win2
deploy-win2: check-ssh-key setup-ansible-collections .run-windows-clients ## Deploy WIN2 only

deploy-windows-clients: check-ssh-key setup-ansible-collections .run-windows-clients ## Deploy both Windows clients

# Linux ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
deploy-linux-app: check-ssh-key setup-ansible-collections .run-linux-app ## Deploy Linux application

##---------------------------------------------------------------------
##@ Combined Deployment
##---------------------------------------------------------------------

deploy-dc: deploy-domain-controllers ## Deploy all domain controllers

deploy-clients: deploy-windows-clients ## Deploy all Windows clients

deploy-linux: deploy-linux-app ## Deploy Linux application

deploy: deploy-domain-controllers deploy-windows-clients deploy-linux-app ## Deploy all components
	@echo ""
	@echo "$(BLUE)=== ğŸ‰ å…¨ä½“æ§‹ç¯‰å®Œäº† ğŸ‰ ===$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸ“‹ æ¥ç¶šæƒ…å ±:$(NC)"
	@echo "  DC1 (DOMAIN1):     $(DC1_IP)"
	@echo "  DC2 (DOMAIN2):     $(DC2_IP)"
	@echo "  WIN1:              $(WIN1_IP)"
	@echo "  WIN2:              $(WIN2_IP)"
	@echo "  Linux App:         $(LINUX_PUBLIC_IP)"
	@echo "  ALB DNS:           $(ALB_DNS_NAME)"
	@echo ""
	@echo "$(YELLOW)ğŸŒ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URL:$(NC)"
	@echo "  WinAuth (ç›´æ¥):    http://$(LINUX_PUBLIC_IP):8082"
	@echo "  WinAuth (ALBçµŒç”±): http://$(ALB_DNS_NAME)"
	@echo ""
	@echo "$(YELLOW)ğŸ–¥ï¸ RDPæ¥ç¶š (Administrator):$(NC)"
	@echo "  DC1:               rdp://$(DC1_IP)"
	@echo "  DC2:               rdp://$(DC2_IP)"
	@echo "  WIN1:              rdp://$(WIN1_IP)"
	@echo "  WIN2:              rdp://$(WIN2_IP)"
	@echo ""
	@echo "$(YELLOW)ğŸ” SSHæ¥ç¶š:$(NC)"
	@EXPANDED_PATH=$$(eval echo "$(SSH_KEY_PATH)"); \
	echo "  Linux App:         ssh -i $$EXPANDED_PATH ec2-user@$(LINUX_PUBLIC_IP)"
	@echo ""
	@echo "$(GREEN)âœ… å…¨ã¦ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼èªè¨¼ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚$(NC)"
	@echo ""

##---------------------------------------------------------------------
##@ Information & Testing
##---------------------------------------------------------------------

show-info: get-cloudformation-outputs ## Show all connection information
	@echo "$(GREEN)âœ… æ¥ç¶šæƒ…å ±ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ$(NC)"

test-urls: get-cloudformation-outputs ## Test application URLs
	@echo "$(GREEN)ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³URLã‚’ãƒ†ã‚¹ãƒˆä¸­...$(NC)"
	@echo ""
	@echo "$(YELLOW)ğŸŒ ç›´æ¥æ¥ç¶šãƒ†ã‚¹ãƒˆ:$(NC)"
	@curl -s -o /dev/null -w "  Status: %{http_code} - %{url_effective}\n" http://$(LINUX_PUBLIC_IP):8082 || echo "  âŒ ç›´æ¥æ¥ç¶šå¤±æ•—"
	@echo ""
	@echo "$(YELLOW)ğŸŒ ALBçµŒç”±ãƒ†ã‚¹ãƒˆ:$(NC)"
	@curl -s -o /dev/null -w "  Status: %{http_code} - %{url_effective}\n" http://$(ALB_DNS_NAME) || echo "  âŒ ALBçµŒç”±æ¥ç¶šå¤±æ•—"
	@echo ""

##---------------------------------------------------------------------
##@ Maintenance
##---------------------------------------------------------------------

clean: ## Remove generated files
	@echo "$(GREEN)ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ä¸­...$(NC)"
	@rm -f ansible/inventory/inventory.yml
	@echo "$(GREEN)âœ“ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ$(NC)"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆ
.DEFAULT_GOAL := help